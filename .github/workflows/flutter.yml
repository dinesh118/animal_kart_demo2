name: Android APK CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      # Set your Flutter channel and optional version pinning
      FLUTTER_CHANNEL: stable
      # Example versioning; you can pass these as secrets instead
      APP_VERSION_NAME: 1.0.0
      APP_VERSION_CODE: 1

    steps:
      # 1) Check out code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set up Java (Gradle/Android tools use JDK)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Set up Flutter SDK with caching
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      # 4) Show tool versions (helpful for debugging)
      - name: Tool versions
        run: |
          flutter --version
          java -version

      # 5) Get dependencies (pub get) with caching support
      - name: Install dependencies
        run: flutter pub get

      # 6) Static analysis to catch issues early
      - name: Analyze code
        run: flutter analyze

      # 7) Run tests (unit tests)
      - name: Run tests
        run: flutter test --coverage

      # 8) Optionally bump app versionCode/versionName via Gradle
      #    You can skip this or manage versions in pubspec.yaml/build.gradle.
      - name: Update Android version (optional)
        run: |
          echo "Keeping versions static for now. Consider scripting version bumps later."

      # 9a) Build an unsigned release APK (simple first practice)
      - name: Build unsigned release APK
        run: flutter build apk --release

      # 9b) Build a signed release APK (production) - requires signing config in android/app/build.gradle
      #     Uncomment to produce a signed artifact once signing is configured:
      # - name: Prepare keystore from secret
      #   if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      #   run: |
      #     echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
      #   env:
      #     ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      #
      # - name: Build signed release APK
      #   env:
      #     KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      #     KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #   run: |
      #     # Gradle uses signingConfigs defined in android/app/build.gradle
      #     flutter build apk --release

      # 10) Upload artifacts so you or testers can download them
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      # 11) Save test coverage (optional)
      - name: Upload coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/lcov.info
